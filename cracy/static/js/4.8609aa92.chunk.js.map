{"version":3,"sources":["pages/Home/index.js","service/index.js"],"names":["packageJson","require","connect","address","invite","parseQuery","getQuery","useState","balance","setBalance","btcLight","setBtcLight","invitedAddress","setInvitedAddress","certPrice","setCertPrice","btcPrice","setBrcPrice","isLoading","setIsLoading","code","setCode","openStatus","setOpenStatus","getIdentity","getBalance","then","data","ret","btclight","time","status","undefined","getCertPrice","addr","getPrice","toast","value","btcusdt","window","demos","contract","type","openUpFromTxid","cracyTxidCache","set","cracyInviteAddressCache","err","JSON","stringify","txid","openUpCert","rawtx","remove","changeAddress","e","target","trim","scan","scanQRCode","includes","match","fundManager","openFundManager","useEffect","get","className","src","basicURL","imgSrc","alt","onClick","placeholder","onChange","id","test","disabled","version","axios","post","getGains","page","limit","getFundsPool"],"mappings":"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","file":"static/js/4.8609aa92.chunk.js","sourcesContent":["import React, {useState, useEffect} from 'react';\nimport './style.scss';\nimport {basicURL, toast, parseQuery, cracyTxidCache, cracyInviteAddressCache} from \"../../utils\";\nimport {getBalance, getPrice, openUpCert} from \"../../service\";\nimport {connect, Card, Input, MaskLoading} from \"../../components\"\nlet packageJson = require('../../../package.json');\nlet err = 0;\n\nfunction Home({address}) {\n    const invite = parseQuery.getQuery('invite') || '';\n    const [balance, setBalance] = useState(0); //余额\n    const [btcLight, setBtcLight] = useState(''); //合约地址\n    const [invitedAddress, setInvitedAddress] = useState(invite); //邀请地址\n    const [certPrice, setCertPrice] = useState(0); //证书价格\n    const [btcPrice, setBrcPrice] = useState(0); //btc价格\n    // const [isOpened, setIsOpened] = useState(false); //已开通\n    const [isLoading, setIsLoading] = useState(false); //开通loading\n    const [code, setCode] = useState(''); //邀请人\n    const [openStatus, setOpenStatus] = useState(-1); //开通状态 -1:未开通 0:开通中 1:已开通\n\n    function getIdentity () {\n        getBalance(address).then(({data}) => {\n            // console.log(data);\n            if (data.ret) {\n                let {balance, btclight, code, time, status} = data.data;\n                // time = undefined\n                // status = undefined\n\n                setBalance(balance);\n                setBtcLight(btclight);\n                setCode(code);\n                if (time) {\n                    setOpenStatus(status === undefined ? 1 : status);\n                }\n            }\n        })\n    }\n    function getCertPrice (addr) {\n        getPrice(addr || address).then(({data}) => {\n            // console.log(data);\n            if (data.ret) {\n\n                if (addr) {\n                    toast('邀请地址未开通')\n                } else {\n                    setCertPrice(data.data.value);\n                    setBrcPrice(data.data.btcusdt);\n                }\n            } else if(data.data === 'do not repeat opening') {\n                if (addr) {\n                    openUp();\n                } else {\n                    setOpenStatus(1)\n                }\n\n            }\n        })\n    }\n\n    useEffect(() => {\n        if (!address) return;\n        let txid = cracyTxidCache.get(address);\n        let invite = cracyInviteAddressCache.get(address);\n        txid && invite && openUpFromTxid(txid, invite);\n\n        getIdentity();\n        getCertPrice();\n    }, [address]);\n\n    function submit  () {\n        if(openStatus !== -1) {\n            return\n        }\n        if (!certPrice) {\n            toast('正在获取证书价格，请稍后再试。');\n            return\n        }\n        if (!(balance >= certPrice)) {\n            toast('余额不足');\n            return\n        }\n        if (invitedAddress) {\n            if((process.env.NODE_ENV === 'production' ? /^Sc.+/ : /^Tc.+/).test(invitedAddress + '')) {\n                getCertPrice(invitedAddress);\n            } else {\n                toast('请输入正确的邀请码');\n            }\n\n        } else {\n            // openUp();\n            toast('请输入邀请码');\n        }\n    }\n\n    function openUp () {\n        window.demos.contract(\"pay\", btcLight, [{type: \"uint256\", value: certPrice}, {type:\"string\", value: \"[2]\"}]).then(function (data){\n            openUpFromTxid(data);\n            cracyTxidCache.set(address, data);\n            cracyInviteAddressCache.set(address, invitedAddress);\n        }, function (err) {\n            toast(JSON.stringify(err), 3000);\n        });\n    }\n\n    function openUpFromTxid(txid, invite = invitedAddress) {\n        setIsLoading(true);\n        openUpCert({\n            address,\n            addr: invite,\n            rawtx: txid\n        }).then(function ({data}) {\n            setIsLoading(false);\n            cracyTxidCache.remove(address);\n            cracyInviteAddressCache.remove(address);\n\n            if(data.ret) {\n                toast('开通成功');\n                // setIsOpened(true);\n                setOpenStatus(0);\n                getIdentity();\n            } else {\n                toast(data.data);\n            }\n        }, function (err) {\n            setIsLoading(false);\n            if (err === 0) {\n                openUpFromTxid(txid, invite);\n            } else {\n                err += 1;\n                toast(JSON.stringify(err), 3000);\n            }\n            \n        })\n    }\n\n    function changeAddress (e) {\n        // setInvitedAddress(e.target.value.trim());\n        setInvitedAddress(typeof e === 'string' ? e : e.target.value.trim());\n    }\n\n    function scan () {\n        window.demos.scanQRCode().then(function (data){\n            let addr = data;\n            if(data.includes('invite=')) {\n                addr = data.match(/invite=(\\w+)/)[1]\n            }\n            setInvitedAddress(addr);\n        });\n    }\n\n    function fundManager() {\n        window.demos.openFundManager();\n    }\n\n    async function paste() {\n        function focus () {\n            document.getElementById('p-home-input').focus();\n        }\n        if(!invitedAddress) {\n            try {\n                const value = await window.demos.getClipboard();\n                value ? setInvitedAddress(value) : focus();\n            } catch (e) {\n                focus();\n            }\n        } else {\n            focus();\n        }\n    }\n\n    return (\n        <div className='p-home'>\n            <img src={`${basicURL.imgSrc}/icon_btc.png`} alt=\"btc\" className='coin-icon'/>\n            <p className='balance'>BTC余额:<span>{balance/1e8}</span></p>\n            <div className='btns'>\n                <button className='c-btn' onClick={fundManager}>充值</button>\n                <button className='c-btn' onClick={fundManager}>提现</button>\n            </div>\n            <p className='balance'>BTC价格:<span>$ {btcPrice}</span></p>\n            <p className='price'>需支付:<span>{certPrice/1e8} <i>BTC</i></span></p>\n            <p className='notice'>注意:BTC充值有矿工费用</p>\n            {(() => {\n                if(openStatus !== -1) {\n                    return <Card className='invite'>推荐地址: {code || invitedAddress || '空'}</Card>\n                }\n\n                if(invite) {\n                    return <Card className='invite'>推荐地址: {invite}</Card>\n                }\n\n                return (\n                    <div className='input'>\n                        <div className='input-wrapper'>\n                            <Input\n                                type=\"text\"\n                                placeholder='推荐地址'\n                                onChange={changeAddress}\n                                value={invitedAddress}\n                                id='p-home-input'/>\n                            {/*<i onClick={paste} />*/}\n                        </div>\n                        <img src={`${basicURL.imgSrc}/icon_scan.png`} alt=\"scan\" onClick={scan}/>\n                    </div>\n                )\n            })()}\n            {isLoading && <MaskLoading />}\n            <button className='c-btn' onClick={submit} disabled={isLoading}>\n                {/*{isOpened\n                    ? '已开通'\n                    : isLoading\n                        ? 'loading'\n                        : '开通'\n                }*/}\n                {openStatus === -1\n                    ? isLoading\n                        ? 'loading'\n                        : '开通'\n                    : openStatus === 1\n                        ? '已开通'\n                        : '处理中'\n                }\n            </button>\n            <div className='package-json'>version: {packageJson.version}</div>\n        </div>\n    )\n}\n\nexport default connect()(Home);\n","import {axios} from '../utils'\n\n/** 获取余额 **/\nexport const getBalance = (address) => {\n    return axios.get(`/api/addr/${address}`);\n};\n\n/** 获取价格 **/\nexport const getPrice = (address) => {\n    return axios.post(`/api/addr/${address}/opencert`, {});\n};\n\n/** 开通证书 **/\nexport const openUpCert = ({address, addr, rawtx}) => {\n    return axios.post(`/api/addr/${address}/opencert`, {addr, rawtx});\n};\n\n/** 收益记录 **/\nexport const getGains = ({address, page = 1, limit = 1000000}) => {\n    return axios.get(`/api/addr/${address}/gains?page=${page}&limit=${limit}`);\n};\n\n/** 基金池 **/\nexport const getFundsPool = () => {\n    return axios.get('/api/funds');\n};\n"],"sourceRoot":""}